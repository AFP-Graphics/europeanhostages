{"version":3,"sources":["app/chart.js","app/map.js","app/ui.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAtuBA;AAAA;ACAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAtGA;AAAA;ACAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AA9QA;AAAA","file":"public/js/app.js","sourcesContent":["﻿\"use strict\";\n/**\n * Created by julesbonnard\n */\n\n//Containers\nvar container = d3.select('#dataviz'),\n  svg = container.append('svg'),\n  chart,\n  groupsContainer,\n  groups,\n  bars,\n  barLabels,\n  picto_container = {},\n  grids,\n  extents,\n\n  chartInit = false,\n\n  //Echelles\n  x,\n  xAxis,\n  y,\n  colorScale,\n\n  //Tailles\n  width,\n  height,\n  margin = {\n    top: 30,\n    right: 50,\n    bottom: 25,\n    left: 15\n  },\n  getContainerSize = function() {\n    width = container[0][0].offsetWidth;\n  },\n  resize = function() {\n    //Définition de la nouvelle hauteur après redimensionnement\n    getContainerSize();\n    height = data_filtered.length * 20 +60; //Calcul de la hauteur nécessaire pour le SVG\n    d3.select('g.x.axis.bottom').attr('transform', 'translate(0,' + (height) + ')');\n    svg.attr('width', width)\n      .attr('height', height+30);\n  },\n\n  //Données\n  data_refined,\n  data_filtered,\n  countries = [],\n  hostages,\n  hostages_raw,\n\n  //Formats de dates\n  format = d3.time.format(\"%Y-%m-%dT%H:%M:%S\"), // Parse this type of date : \"2008-10-30T01:00:00\"\n  formatDisplay = d3.time.format(\"%B %Y\"), //Dates dans les tooltips\n  customTimeFormat = d3.time.format(\"%Y\"); //Date sur l'axe x\n\n//Libellés des outcomes\nvar deathList = ['dead', 'dead (unknown)', 'death', 'dead (attempted rescue)', 'dead (executed)', 'executed', 'dead (illness)', 'died from an infection', 'killed', 'murdered', 'dead (killed)'];\nvar freeList = ['freed', 'escape', 'freed (released)', 'liberation', 'freed, injured', 'freed (escaped)', 'freedom', 'freed (realesed)', 'liberated for medical reasons', 'freed (liberated)', 'freed ( released)', 'liberated', 'released', 'release', 'liberated (released)', 'freed (unknown)'];\n\n//Accents et fonction pour le fuzzy matching\nvar accentMap = {\n  \"á\": \"a\",\n  \"ö\": \"o\",\n  \"ï\": \"i\",\n  \"é\": \"e\",\n  \"è\": \"e\",\n  \"ê\": \"e\"\n};\nvar normalize = function(term) {\n  var ret = \"\";\n  for (var i = 0; i < term.length; i++) {\n    ret += accentMap[term.charAt(i)] || term.charAt(i);\n  }\n  return ret;\n};\n\ngetContainerSize();\n\n//Conteneur\nchart = svg.append('g')\n  .attr('transform', 'translate(' + margin.left + ', ' + margin.top + ')')\n  .attr('class', 'chart');\n\n//X Axis\nchart.append('g')\n  .attr('class', 'x axis top');\nchart.append('g')\n  .attr('class', 'x axis bottom');\n\nd3.select('g.x.axis.top').append('text')\n  .attr('class', 'label')\n  .text('Years');\n\n//Conteneur des grilles\ngrids = chart.append('g')\n  .attr('class', 'grid x')\n\n//Conteneur des bars\ngroupsContainer = chart.append('g')\n  .attr('class', 'groups');\n\n//Fonction de définition des bornes chronologiques\nfunction extentsTimeline() {\n  var min = d3.min(data_refined, function(d) {\n    return d.date_taken_hostage;\n  });\n  var max = d3.max(data_refined, function(d) {\n    return d.date_hostage_status_ends;\n  });\n\n  return [format.parse(min), format.parse(max)];\n}\n\n//Calculer nombre de jours entre deux dates\nfunction dayDiff(d1, d2) {\n  d1 = format.parse(d1).getTime() / 86400000;\n  if (d2 == null) {\n    d2 = new Date().getTime() / 86400000;\n  } else {\n    d2 = format.parse(d2).getTime() / 86400000;\n  }\n  return parseInt(new Number(d2 - d1).toFixed(0));\n}\n\n//Process des données\nfunction initChart(datafile) {\n  //Suppression des dates de début inconnues\n  data_refined = datafile.filter(function(d) {\n    return d.date_taken_hostage !== null;\n  });\n\n  //Calcul de la durée de l'évènement\n  data_refined.forEach(function(d, i) {\n    data_refined[i]['duration'] = dayDiff(d.date_taken_hostage, d.date_hostage_status_ends);\n  });\n\n  //Copie des données pour filtrage\n  data_filtered = data_refined;\n\n  chartInit = true;\n\n  // //Enumération et tri des pays\n  // hostages_files.forEach(function(d) {\n  //     d.is_citizen_of.forEach(function(e) {\n  //         countries.push(e.name);\n  //     });\n  // });\n\n  // countries = _.uniq(countries).sort(function (b, a) {\n  //     if (a < b) return 1;\n  //     if (b < a) return -1;\n  //     return 0;\n  // });\n\n  //Suppression de la barre de chargement\n  d3.select('#loader').remove();\n\n  //Surveillance du redimensionnement\n  d3.select(window).on('resize', Chart.drawGraph);\n\n  //Création du graphique\n  Chart.drawGraph();\n}\n\n//Data binding\nfunction addBars() {\n  //Définition de l'axe vertical\n  y = d3.scale.linear().domain([0, data_filtered.length]).range([margin.top, height - margin.bottom]);\n\n  //Liaison des données avec les conteneurs des bars+texte+picto\n  groups = groupsContainer.selectAll(\"g.barGroup\")\n    .data(data_filtered, function(d) {\n      return d.id;\n    });\n\n  var groupsEnter = groups.enter().append('g')\n    .attr('class', \"barGroup\")\n    .attr(\"index\", function(d, i) {\n      return d.id;\n    })\n    .attr('id', function(d, i) {\n      return d.id;\n    })\n    .attr(\"transform\", function(d, i) {\n      return \"translate(0, \" + y(i) + \")\";\n    })\n    .on('click', function(d) {\n      //console.log(d);\n      //d3.select(this).classed('selected', !d3.select(this).classed('selected'));\n    });\n\n  //ajout des barres\n  groupsEnter.append('rect')\n    .attr('class', 'bar')\n    .attr('x', 0)\n    .attr('width', 0)\n    .attr('height',10)\n    .attr(\"title\", function(d) {\n      return 'event,' + d.id;\n    })\n    .style('fillOpacity',0.4);\n\n  groupsEnter.append('circle')\n    .attr('class', 'point start')\n    .attr('cx', 0)\n    .attr('cy', 4.5)\n    .attr('r', 7);\n\n  groupsEnter\n    .filter(function(d) {\n      return d.date_hostage_status_ends !== null;\n    })\n    .append('circle')\n    .attr('class', 'point end')\n    .attr('cx', 0)\n    .attr('cy', 4.5)\n    .attr('r', 7);\n\n  //ajout des textes\n  groupsEnter.append('text')\n    .attr('class', 'barLabel')\n    .attr(\"title\", function(d) {\n      return 'event,' + d.id;\n    })\n    .attr(\"data-eventid\", function(d) {\n      return d.id;\n    })\n    .attr(\"data-toggle\", \"modal\")\n    .attr(\"data-target\", \"#moreInfo\")\n    .attr('y', 13)\n    //TODO : gérer la couleur en CSS\n    .attr('fill', '#aaa')\n    .on('mouseover', function(d) {\n      d3.select(this).attr('fill', 'black');\n    })\n    .on('mouseout', function(d) {\n      d3.select(this).attr('fill', '#aaa');\n    })\n    .text(function(d) {\n      return d.name;\n    });\n\n  //Ajout des pictos\n  groups\n    .each(function(d, i) {\n      picto_container[d.id] = d3.select(this).selectAll('.picto')\n        .data(d.concerns_these_hostages.filter(filterPictos), function(e) {\n          return e.id;\n        });\n\n      picto_container[d.id].enter()\n        .append('circle')\n        .attr('class', 'picto')\n        .attr('id', function(e) {\n          return e.id;\n        })\n        .attr('fill', function(e) {\n          if (e.outcome != undefined && _.contains(deathList, e.outcome.toLowerCase().trim())) {\n            return '#575e61';\n          } else if (e.outcome != undefined && _.contains(freeList, e.outcome.toLowerCase().trim())) {\n            return '#87b9db';\n          } else {\n            return '#c4bdb5';\n          }\n        })\n        .attr('cx', 0)\n        .attr('cy', 7)\n        .attr('r', 7)\n        .attr('display', 'none');\n\n      picto_container[d.id].exit().remove();\n    });\n\n  //Suppression des groupes non nécesaires\n  var groupsExit = groups.exit();\n  groupsExit.selectAll('rect').remove();\n  groupsExit.selectAll('text').remove();\n  groupsExit.remove();\n}\n\n//Gestion des transitions\nfunction updateData() {\n  switch (UI.currentSort) {\n    case 'duration':\n      var ticks = 10;\n      ticks = width / 70;\n      d3.select('g.x.axis.top .label').text('Days');\n      break;\n    case 'timeline':\n      var ticks = 15;\n      ticks = width / 70;\n      d3.select('g.x.axis.top .label').text('Years');\n      break;\n    case 'hostages':\n      var ticks = 10;\n      ticks = width / 70;\n      d3.select('g.x.axis.top .label').text('Number of hostages');\n      break;\n    default:\n      var ticks = 5;\n  }\n\n  // Modification de l'axe x\n  chart.selectAll('g.x.grid>line').remove();\n  grids.selectAll('g.x.grid>line')\n    .data(x.ticks(ticks))\n    .enter().append(\"line\")\n    .attr(\"class\", \"x\")\n    .attr(\"x1\", x)\n    .attr(\"x2\", x)\n    .attr(\"y1\", 30)\n    .attr(\"y2\", height);\n\n  //Modification des barres\n  bars = groups.selectAll('rect');\n\n  bars.transition()\n    .attr('x', function(d) {\n      switch (UI.currentSort) {\n        case 'duration':\n          return x(0);\n          break;\n        case 'timeline':\n          return x(format.parse(d.date_taken_hostage));\n          break;\n        case 'hostages':\n          return x(0);\n          break;\n      }\n    })\n    .attr('width', function(d) {\n      switch (UI.currentSort) {\n        case 'duration':\n          return x(d.duration);\n          break;\n        case 'timeline':\n          if (d.date_hostage_status_ends == null) {\n            return x(new Date()) - x(format.parse(d.date_taken_hostage));\n          }\n          return x(format.parse(d.date_hostage_status_ends)) - x(format.parse(d.date_taken_hostage));\n          break;\n        case 'hostages':\n          //return x(d['number_of_hostages_including_non-e30']);\n          break;\n      }\n    })\n    .duration(250)\n    .delay(0)\n    .ease(\"linear\")\n    .attr('display', function() {\n      switch (UI.currentSort) {\n        case 'timeline':\n          return 'block';\n        case 'duration':\n          return 'block';\n        default:\n          return 'none';\n      }\n    });\n\n  groups.selectAll('.point.start').transition()\n    .attr('cx', function(d) {\n      switch (UI.currentSort) {\n        case 'duration':\n          return x(0);\n          break;\n        case 'timeline':\n          return x(format.parse(d.date_taken_hostage));\n          break;\n        case 'hostages':\n          return x(0);\n          break;\n      }\n    })\n    .attr('display', function() {\n      switch (UI.currentSort) {\n        case 'timeline':\n          return 'block';\n        case 'duration':\n          return 'block';\n        default:\n          return 'none';\n      }\n    });\n\n  groups.selectAll('.point.end').transition()\n    .attr('cx', function(d) {\n      switch (UI.currentSort) {\n        case 'duration':\n          return x(d.duration);\n          break;\n        case 'timeline':\n          return x(format.parse(d.date_hostage_status_ends));\n          break;\n        case 'hostages':\n          return x(0);\n          break;\n      }\n    })\n    .attr('display', function() {\n      switch (UI.currentSort) {\n        case 'timeline':\n          return 'block';\n        case 'duration':\n          return 'block';\n        default:\n          return 'none';\n      }\n    });\n\n  //MAJ des labels\n  barLabels = groups.selectAll('text');\n  barLabels.transition().attr('x', function(d) {\n      switch (UI.currentSort) {\n        case 'duration':\n          return x(d.duration) + 15;\n          break;\n        case 'timeline':\n          if (d.date_hostage_status_ends == null) {\n            return x(format.parse(d.date_taken_hostage)) - 15;\n          }\n          if (x(format.parse(d.date_taken_hostage)) <= width / 3) {\n            return 15 + x(format.parse(d.date_hostage_status_ends));\n          } else {\n            return x(format.parse(d.date_taken_hostage)) - 15;\n          }\n          break;\n        case 'hostages':\n          return x(d.concerns_these_hostages.filter(filterPictos).length) + 30;\n          break;\n      }\n    })\n    .attr('text-anchor', function(d) {\n      switch (UI.currentSort) {\n        case 'duration':\n          return 'start';\n          break;\n        case 'timeline':\n          if (x(format.parse(d.date_taken_hostage)) <= width / 3) {\n            return 'start';\n          } else {\n            return 'end';\n          }\n          break;\n        case 'hostages':\n          return 'start';\n          break;\n      }\n    })\n    .duration(250)\n    .delay(0)\n    .ease(\"linear\");\n\n  //MAJ des pictos\n  groups.each(function(d) {\n    picto_container[d.id]\n      .sort(function(a, b) {\n        return d3.descending(Chart.filterPictosByOutcome(a), Chart.filterPictosByOutcome(b)) || d3.descending(Chart.filterPictosByUnknownOutcome(a), Chart.filterPictosByUnknownOutcome(b));\n      })\n      .transition()\n      .attr('cx', function(e, i) {\n        switch (UI.currentSort) {\n          case 'duration':\n            return 10 + x(d.duration) + i * 17;\n            break;\n          case 'timeline':\n            if (d.date_hostage_status_ends == null) {\n              return 10 + x(new Date()) + i * 15;\n            }\n            return 10 + x(format.parse(d.date_hostage_status_ends)) + i * 17;\n            break;\n          case 'hostages':\n            return x(i + 1);\n            break;\n        }\n      })\n      .delay(0)\n      .ease(\"linear\")\n      .attr('display', function() {\n        switch (UI.currentSort) {\n          case 'hostages':\n            return 'block';\n          default:\n            return 'none';\n        }\n      });\n  });\n}\n\n//Fonction de tri, sélection du tab actif, resize et url\nfunction sortBy(criteria) {\n  UI.currentSort = criteria;\n  //Sélection du lien actif\n  UI.toggleActive(UI.currentSort, 'sort');\n  if(chartInit==false) return false;\n\n  resize();\n  \n  UI.changeUrl();\n\n  switch (criteria) {\n    case 'duration':\n      var max = d3.max(data_filtered, function(d) {\n        return d.duration;\n      });\n      extents = [0, max + max / 3];\n\n      x = d3.scale.linear().domain(extents).rangeRound([0, width - margin.left - margin.right]);\n\n      xAxis = d3.svg.axis()\n        .scale(x)\n        .orient('bottom')\n        .ticks(width / 100)\n        .tickSize(2)\n        .tickPadding(8);\n\n      chart.selectAll('g.x.axis').call(xAxis);\n\n      chart.selectAll(\"g.barGroup\")\n        .sort(function(b, a) {\n          return a.duration - b.duration;\n        })\n        .transition()\n        .attr(\"transform\", function(d, i) {\n          return \"translate(0, \" + y(i) + \")\";\n        });\n      d3.selectAll('.legend-locations').classed('nocolor', false);\n      d3.selectAll('.legend-hostages').style('display', 'none');\n      updateData();\n      break;\n    case 'timeline':\n      extents = extentsTimeline();\n      x = d3.time.scale().domain(extents).rangeRound([0, width - margin.left - margin.right]);\n\n      xAxis = d3.svg.axis()\n        .scale(x)\n        .orient('bottom')\n        .ticks(width / 100)\n        .tickFormat(customTimeFormat)\n        .tickSize(2)\n        .tickPadding(8);\n\n      chart.selectAll('g.x.axis').call(xAxis);\n\n      chart.selectAll(\"g.barGroup\")\n        .sort(function(a, b) {\n          return format.parse(a.date_taken_hostage) - format.parse(b.date_taken_hostage);\n        })\n        .transition()\n        .attr(\"transform\", function(d, i) {\n          return \"translate(0, \" + y(i) + \")\";\n        });\n      d3.selectAll('.legend-locations').classed('nocolor', false);\n      d3.selectAll('.legend-hostages').style('display', 'none');\n      updateData();\n      break;\n    case 'hostages':\n      x = d3.scale.linear().domain([1, 30]).rangeRound([0, width - margin.left - margin.right]);\n\n      xAxis = d3.svg.axis()\n        .scale(x)\n        .orient('bottom')\n        .ticks(width / 150)\n        .tickSize(2)\n        .tickPadding(8);\n\n      chart.selectAll('g.x.axis').call(xAxis);\n\n      chart.selectAll(\"g.barGroup\")\n        .sort(function(b, a) {\n          var aHostagesD = a.concerns_these_hostages.filter(Chart.filterPictosByOutcome).length,\n            bHostagesD = b.concerns_these_hostages.filter(Chart.filterPictosByOutcome).length,\n            aHostagesU = a.concerns_these_hostages.filter(Chart.filterPictosByUnknownOutcome).length,\n            bHostagesU = b.concerns_these_hostages.filter(Chart.filterPictosByUnknownOutcome).length,\n            aHostages = a.concerns_these_hostages.length,\n            bHostages = b.concerns_these_hostages.length;\n          if (aHostagesD !== bHostagesD) {\n            return d3.ascending(aHostagesD, bHostagesD);\n          } else if (aHostagesU !== bHostagesU) {\n            return d3.ascending(aHostagesU, bHostagesU);\n          } else {\n            return d3.ascending(aHostages, bHostages);\n          }\n        })\n        .transition()\n        .attr(\"transform\", function(d, i) {\n          return \"translate(0, \" + y(i) + \")\";\n        });\n      d3.selectAll('.legend-locations').classed('nocolor', true);\n      d3.selectAll('.legend-hostages').style('display', 'block');\n      updateData();\n      break;\n    default:\n  }\n}\n\n//Colorier les barres\nfunction colorBy(criteria) {\n  UI.currentColor = criteria;\n  switch (criteria) {\n    case 'locations':\n      chart.selectAll(\"g.barGroup>rect.bar\")\n        .attr('fill', function(d) {\n          return UI.countriesColored[d.happened_in[0]];\n        });\n\n      chart.selectAll(\"g.barGroup>.point\")\n        .attr('fill', function(d) {\n          return UI.countriesColored[d.happened_in[0]];\n        });\n      break;\n    default:\n  }\n}\n\n//Filtre si la nationalité est sélectionnée dans le select\nfunction filterByNationality(e) {\n  switch (UI.nationalitySelected) {\n    case 'all':\n      return true;\n      break;\n    default:\n      var ok = false;\n      e.is_citizen_of.forEach(function(f) {\n        if (UI.nationalitySelected == f) {\n          ok = true;\n        }\n      });\n      return ok;\n      break;\n  }\n}\n\n//Filtre si le nom ou pays de l'otage est recherché dans le input\nfunction filterPictos(e) {\n  var matcher = new RegExp(UI.search, \"i\"),\n  ok;\n  if (filterByNationality(e) == true && (UI.search == null || matcher.test(e.name) == true || matcher.test(e.profession_activity) == true)) {\n    ok = true;\n  }\n  //var ok;\n  //TODO : fix\n  /*e.involved_in_this_event.forEach(function(d) {\n      if (matcher.test(d.name) == true || matcher.test(normalize(d.name)) == true) {\n          ok = true;\n      }\n  });*/\n  return ok == true;\n}\n\n//Filtrer les barres selon la nationalité, le champ de recherche ou le pays sélectionné\nfunction filter() {\n  if (UI.nationalitySelected == 'all') {\n    data_filtered = data_refined;\n  } else {\n    data_filtered = data_refined.filter(function(d) {\n      var ok;\n      d.concerns_these_hostages.forEach(function(e) {\n        ok = filterByNationality(e);\n      });\n      return ok == true;\n    });\n  }\n  if (UI.search !== null) {\n    data_filtered = data_filtered.filter(function(d) {\n      var matcher = new RegExp(UI.search, \"i\");\n      if (matcher.test(d.name) == true || matcher.test(normalize(d.name)) == true) {\n        return true == true;\n      } else {\n        var ok;\n        d.concerns_these_hostages.forEach(function(e) {\n          if (matcher.test(e.name) == true || matcher.test(normalize(e.name)) == true || matcher.test(e.profession_activity) == true || matcher.test(e.profession_activity) == true) {\n            ok = true;\n          }\n        });\n        d.happened_in.forEach(function(e) {\n          if (matcher.test(e) == true || matcher.test(normalize(e)) == true || matcher.test(e.profession_activity) == true || matcher.test(e.profession_activity) == true) {\n            ok = true;\n          }\n        });\n        return ok == true;\n      }\n    })\n  }\n  if (UI.locations_filtered !== null) {\n    data_filtered = data_filtered.filter(function(d) {\n      var ok;\n      d.happened_in.forEach(function(value, key) {\n        if (UI.locations_filtered.indexOf(value) > -1) {\n          ok = true;\n        }\n      });\n      return ok == true;\n    });\n  }\n}\n\n//Création du module\nvar Chart = {\n  init: function(datafile) {\n    initChart(datafile);\n  },\n  //Ordre de création du graphique\n  drawGraph: function() {\n    if(chartInit==false) return false;\n    filter();\n    resize();\n    addBars();\n    sortBy(UI.currentSort);\n    colorBy(UI.currentColor);\n  },\n  //Sélectionner seulement les otages selon l'issue\n  filterPictosByOutcome: function(e) {\n    if (e.outcome !== undefined) {\n      return _.contains(deathList, e.outcome.toLowerCase().trim()) == true;\n    } else {\n      return false;\n    }\n  },\n  //Idem pour les issues inconnues\n  filterPictosByUnknownOutcome: function(e) {\n    if (e.outcome !== undefined) {\n      if (_.contains(freeList, e.outcome.toLowerCase().trim()) == false && _.contains(deathList, e.outcome.toLowerCase().trim()) == false) {\n        return true;\n      } else {\n        return false;\n      }\n    } else {\n      return false;\n    }\n  },\n  sortBy: function(criteria) {\n    sortBy(criteria);\n  },\n  data_indexed: null,\n  deathList: deathList,\n  freeList: freeList\n};\n\nmodule.exports = Chart;","\"use strict\";\n/**\n * Created by julesbonnard.\n */\n\n//Création de la carte\nL.mapbox.accessToken =\n  'pk.eyJ1IjoiYWdlbmNlZnJhbmNlcHJlc3NlIiwiYSI6Ijk5YjI2NGE0MDdlYTE1NGY5ZjVjYmMwYjJmNjY3ZWJlIn0.crFebhJyP1aJ7uY2B12C2A';\nvar map = L.mapbox.map('leafletMap', 'agencefrancepresse.6906a779', {\n  center: new L.LatLng(29, 16),\n  maxBounds: [\n    [84, 149],\n    [-76, -133]\n  ],\n  maxZoom: 5,\n  minZoom: 1,\n  zoomControl: false,\n  legendControl: {\n    position: 'topleft'\n  }\n});\nif (d3.select('#map')[0][0].offsetWidth > 460) {\n  map.setZoom(2);\n} else {\n  map.setZoom(1);\n}\n// Disable drag and zoom handlers.\nmap.scrollWheelZoom.disable();\nnew L.Control.Zoom({\n  position: 'topright'\n}).addTo(map);\nmap.legendControl.addLegend(document.getElementById('mapInfo').innerHTML);\n\nfunction updateList(timeline) {\n  var displayed = timeline.getDisplayed();\n  var list = document.getElementById('displayed-list');\n  list.innerHTML = \"\";\n  displayed.forEach(function(event) {\n    var li = document.createElement('li');\n    li.innerHTML = event.properties.name;\n    li.setAttribute('data-eventId', event.properties.id);\n    li.setAttribute('data-toggle', \"modal\");\n    li.setAttribute('data-target', \"#moreInfo\");\n    list.appendChild(li);\n  });\n}\nfunction addTimeline(geojson) {\n  geojson.features.forEach(function(hevent,key) {\n    if(Chart.data_indexed[hevent.properties.id]!==undefined) {\n      geojson.features[key].properties.id = parseInt(hevent.properties.id);\n      geojson.features[key].properties.name = Chart.data_indexed[hevent.properties.id].name;\n      geojson.features[key].properties.start = Chart.data_indexed[hevent.properties.id].date_taken_hostage;\n      if(Chart.data_indexed[hevent.properties.id].date_hostage_status_ends == null) {\n        geojson.features[key].properties.end = new Date();\n      }\n      else {\n        geojson.features[key].properties.end = Chart.data_indexed[hevent.properties.id].date_hostage_status_ends;\n      }\n    }\n  });\n  var timeline = L.timeline(geojson, {\n    formatDate: function(date) {\n      return moment(date).format(\"YYYY\");\n    },\n    pointToLayer: function(geojson, latlng) { \n      return L.circleMarker(latlng, {\n        radius: Math.sqrt(Chart.data_indexed[geojson.properties.id].concerns_these_hostages.length *Math.PI) *3,\n        color: \"#fff\",\n        fillColor: \"#0096c7\",\n        opacity: 1,\n        fillOpacity: 1\n      });\n    },\n    position: 'bottomleft',\n    waitToUpdateMap: false,\n    showTicks: true,\n    enablePlayback: true\n  });\n  timeline.addTo(map);\n  timeline.on('change', function(e) {\n    updateList(e.target);\n  });\n  timeline.on('click', function(e) {\n    UI.moreInfoId = e.layer.feature.properties.id;\n    $('#moreInfo').modal(e);\n  })\n  updateList(timeline);\n  //Suppression de la barre de chargement\n  d3.select('#loader').remove();\n}\n\n//Création du module\nvar Map = {\n  init: function(geojson) {\n    addTimeline(geojson);\n  },\n  resize: function() {\n    map.invalidateSize();\n  }\n};\n\nmodule.exports = Map;\n","\"use strict\";\n/**\n * Created by julesbonnard.\n */\nvar url = new URI(window.location.href); //Détection de l'URL et parsing avec URI;\n\n//Création du module\nvar UI = {\n  url: url,\n\n  //Etapes de l'appli\n  currentSort: url.search(true).sort || 'timeline',\n  currentColor: 'locations',\n  nationalitySelected: slashRemove(url.search(true).nationality) || 'all',\n  search: slashRemove(url.search(true).search) || null,\n  locations_filtered: url.search(true).locations || null,\n\n  //Conteneur des couleurs pour les barres\n  countriesColored: {},\n  //conteneur de l'identifiant pour l'affichage du modal\n  moreInfoId: null,\n\n  //Changer la couleur des liens du menu\n  toggleActive: function(link, type) {\n    d3.selectAll('.' + type).classed('active', 0);\n    d3.selectAll(\".\" + link).classed('active', 1);\n    _gaq.push(['_trackEvent', 'tabs', 'show', link]);\n  },\n  //Changement de l'URL en fonction des paramètres\n  changeUrl: function() {\n    UI.url.setSearch({\n      sort: UI.currentSort,\n      locations: UI.locations_filtered,\n      nationality: UI.nationalitySelected\n    });\n    if (typeof(history.pushState) != \"undefined\") {\n      var obj = {\n        Title: $(document).find(\"title\").text(),\n        Url: UI.url.resource()\n      };\n      history.pushState(obj, obj.Title, obj.Url);\n    } else {\n      console.warn(\"Browser does not support HTML5.\");\n    }\n  }\n};\n\n//Sélection de l'onglet actif\nif (UI.currentSort == 'map') {\n  $('#tabs a[href=\"#map\"]').tab('show');\n} else if (UI.currentSort == 'about') {\n  $('#tabs a[href=\"#about\"]').tab('show');\n} else {\n  $('#tabs a[href=\"#data\"]').tab('show');\n}\n//Comportement au clic\n$('nav li a').on('click', function() {\n  $(this).tab('show');\n  Chart.sortBy(this.getAttribute('data-tabtarget'));\n  if (this.dataset.tabtarget == \"map\" && Map !== undefined) Map.resize();\n  return false;\n});\n\n//Retirer les slashs qui apparaissent à la fin de l'url\nfunction slashRemove(item) {\n  var slashRemove = new RegExp(\"/\", 'g');\n  if (item !== null && item !== undefined) {\n    item = item.replace(slashRemove, \"\");\n  }\n  return item;\n}\n\n\n//Possibilité d'afficher seulement la dataviz\nif (UI.url.search(true).header == 'hidden') {\n  d3.select(\"header\").style('display', 'none');\n  d3.select(\".menu-block\").style('display', 'none');\n  d3.select(\".legend\").style('display', 'none');\n  d3.select(\".source\").style('display', 'block');\n}\n\n\n//Remplir un tableau de couleurs par pays\n//Liste des régions et couleurs (Définition de l'ONU -> http://unstats.un.org/unsd/methods/m49/m49regin.htm)\nvar countriesColors = [{\n  'name': 'North Africa',\n  'countries': [\"algeria\",\"egypt\",\"tunisia\",\"libya\",\"sudan\"],\n  'color': '#ffe17e'\n}, {\n  'name': 'West Africa',\n  'countries': [\"ivory coast\", \"mali\",\"niger\",\"nigeria\", \"mauritania\"],\n  'color': '#f1923f'\n}, {\n  'name': 'Central Africa',\n  'countries': [\"angola\",\"cameroon\",\"central african republic\",\"chad\",\"democratic republic of congo\"],\n  'color': '#de9f6b'\n}, {\n  'name': 'East Africa',\n  'countries': [\"ethiopia\",\"kenya\",\"rwanda\",\"seychelles\",\"somalia\",\"south sudan\"],\n  'color': '#a17457'\n}, {\n  'name': 'Middle East',\n  'countries': ['turkey', 'lebanon', 'iraq', 'syria','palestine', 'israel', 'yemen', 'saudi arabia'],\n  'color': '#6269ad'\n}, {\n  'name': 'South America',\n  'countries': ['colombia', 'venezuela', 'guatemala', 'mexico'],\n  'color': '#6db6a6'\n}, {\n  'name': 'Russia-Georgia',\n  'countries': ['russia', 'georgia'],\n  'color': '#ee8280'\n}, {\n  'name': 'Asia',\n  'countries': ['pakistan', 'afghanistan', 'philippines', 'india', 'cambodia'],\n  'color': '#afaaa2'\n}];\n\ncountriesColors.forEach(function(value, key) {\n  value.countries.forEach(function(value2, key2) {\n    UI.countriesColored[value2] = value.color;\n  });\n});\n\nfunction toTitleCase(str)\n{\n    return ' '+str.replace(/\\w\\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});\n}\n\n//Créer la légende\nd3.select('ul.legend-locations').selectAll('.legend-locations li').data(countriesColors).enter()\n  .append('li')\n  .attr('title', function(d) {\n    return d.countries.map(toTitleCase).concat();\n  })\n  .text(function(d) {\n    return d.name;\n  })\n  .on('click', function(d) {\n    if (UI.locations_filtered == d.countries) {\n      UI.locations_filtered = null;\n      d3.select('ul.legend-locations li.selected').classed('selected', false);\n      d3.selectAll('ul.legend-locations,.removeFilters').classed('selected', false);\n    } else {\n      d3.selectAll('ul.legend-locations,.removeFilters').classed('selected', true);\n      d3.select('ul.legend-locations li.selected').classed('selected', false);\n      d3.select(this).classed('selected', true);\n      UI.locations_filtered = d.countries;\n    }\n    Chart.drawGraph();\n  })\n  .append('span')\n  .style('background', function(d) {\n    return d.color;\n  });\n//Bouton supprimer les filtres\n$('.removeFilters').on('click', function() {\n  UI.locations_filtered = null;\n  d3.select('ul.legend-locations li.selected').classed('selected', false);\n  d3.selectAll('ul.legend-locations,.removeFilters').classed('selected', false);\n  Chart.drawGraph();\n});\n//Sélection le filtre actif\nif (UI.locations_filtered !== null) {\n  d3.selectAll('.legend-locations li').each(function(d) {\n    if (d.countries[0] == UI.locations_filtered[0]) {\n      d3.selectAll('ul.legend-locations,.removeFilters').classed('selected', true);\n      d3.select(this).attr('class', 'selected');\n    }\n  });\n}\n\n//Fonctionnement du select\nd3.select('#countries').on('change', function() {\n  UI.nationalitySelected = this.options[this.selectedIndex].value;\n  Chart.drawGraph();\n});\n//Sélection du filtre selon l'URL ou par défaut\nif (UI.url.search(true).nationality !== undefined) {\n  d3.select('#countries option[value=' + UI.nationalitySelected + ']').attr('selected', 'selected');\n}\n//et du champ recherche\nd3.select('#search').attr('value', UI.search);\n\n\n\n//Configuration du modal Bootstrap pour plus d'infos\n$('#moreInfo').on('show.bs.modal', function(e) {\n  if (e.relatedTarget !== undefined) {\n    var recipient = e.relatedTarget.__data__.id;\n    var hostageEvent = Chart.data_indexed[recipient];\n  } else {\n    var hostageEvent = Chart.data_indexed[UI.moreInfoId];\n  }\n\n  var duration;\n\n  if (hostageEvent.duration <= 1) {\n    duration = 'a day or less';\n  } else {\n    duration = moment.duration(hostageEvent.duration, 'days').humanize();\n  }\n\n  var hostagesTable = '<div class=\"listHostages row\">';\n  hostageEvent.concerns_these_hostages.sort(function(a, b) {\n    return d3.descending(Chart.filterPictosByOutcome(a), Chart.filterPictosByOutcome(b)) || d3.descending(Chart.filterPictosByUnknownOutcome(a), Chart.filterPictosByUnknownOutcome(b));\n  }).forEach(function(value, key) {\n    hostagesTable += '<div class=\"col-xs-12 col-sm-6 col-lg-6\">' + value.name.split('[')[0].trim();\n    if (value.outcome != undefined && _.contains(Chart.deathList, value.outcome.toLowerCase().trim())) {\n      hostagesTable += ' <span class=\"label label-default\">' + value.outcome + '</span>';\n    } else if (value.outcome != undefined && _.contains(Chart.freeList, value.outcome.toLowerCase().trim())) {\n      hostagesTable += ' <span class=\"label label-primary\">' + value.outcome + '</span>';\n    } else {\n      hostagesTable += ' <span class=\"label label-warning\">' + value.outcome + '</span>';\n    }\n    hostagesTable += '</div>';\n  });\n  hostagesTable += '</div>';\n\n  //var title = '<a target=\"_blank\" href=\"https://www.detective.io/afp/hostage-project/contribute/?type=hostageevent&id=' + hostageEvent.id + '\">' + hostageEvent.name + '</a>';\n  var title = hostageEvent.name;\n\n  _gaq.push(['_trackEvent', 'modal', 'show', hostageEvent.name]);\n  var modal = $(this);\n  modal.find('.modal-header').css('background-color', UI.countriesColored[hostageEvent.happened_in[0]]);\n  modal.find('.modal-title').html(title);\n  modal.find('.duration').text(duration);\n  modal.find('.hostages').html(hostagesTable);\n  modal.find('.modal-body .description').html(hostageEvent.description);\n});\n\n\n//Comportement du champ recherche. Timeout pour fluidité\nvar timeout;\nd3.select('#search').on('input', function(d) {\n  var that = this;\n  clearTimeout(timeout);\n  timeout = setTimeout(function() {\n    if (that.value.length >= 3) {\n      UI.search = that.value;\n      UI.url.setSearch({\n        search: UI.search\n      });\n      Chart.drawGraph();\n    }\n    if (that.value.length == 0) {\n      UI.search = null;\n      UI.url.removeSearch('search');\n      Chart.drawGraph();\n    }\n  }, 300);\n});\n\n//Ouverture d'un popup au clic sur les réseaux sociaux\nfunction fbs_click(link, width, height) {\n  var leftPosition, topPosition;\n  //Allow for borders.\n  leftPosition = (window.screen.width / 2) - ((width / 2) + 10);\n  //Allow for title and status bars.\n  topPosition = (window.screen.height / 2) - ((height / 2) + 50);\n  var windowFeatures = \"status=no,height=\" + height + \",width=\" + width + \",resizable=yes,left=\" + leftPosition + \",top=\" + topPosition + \",screenX=\" + leftPosition + \",screenY=\" + topPosition + \",toolbar=no,menubar=no,scrollbars=no,location=no,directories=no\";\n  window.open(link.href, 'sharer', windowFeatures);\n  return false;\n}\n$('#twitterButton a,#facebookButton a').on('click', function() {\n  fbs_click(this, 700, 300);\n  return false;\n});\n\n\nmodule.exports = UI;"]}